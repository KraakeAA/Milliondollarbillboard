<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Million Dollar Billboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PayPal SDK configured for GBP Payment -->
    <script src="https://www.paypal.com/sdk/js?client-id=ATP3i6lIdhX-ot734c4Hg5HCButYu740X7g5H7L3RVmZ4UTbbG-LC8d819AiTpbQFOPxa71ju82KgYZ7&currency=GBP"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://www.css.gg/css?=|check|info" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            background-image: radial-gradient(circle at 50% 30%, rgba(0, 255, 255, 0.05), rgba(10, 10, 10, 0) 30%);
        }
        .billboard-frame {
            background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.5); position: relative;
        }
        .billboard-spotlight {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 60%; height: 40px; background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
            clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%); opacity: 0.5;
        }
        .billboard-stand {
            width: 100px; height: 80px; background: #1a1a1a; margin: 0 auto; position: relative;
            border-left: 2px solid #333; border-right: 2px solid #333; border-bottom: 2px solid #333;
        }
        .billboard-stand::before {
            content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 20px; background: #111; border-radius: 5px; border: 2px solid #333;
        }
        .canvas-container canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        #pixel-grid {
            image-rendering: pixelated; image-rendering: crisp-edges;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
            z-index: 1;
        }
        #selection-canvas {
            cursor: crosshair;
            z-index: 5;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
    </style>
</head>
<body class="text-gray-200 overflow-x-hidden">

    <header class="text-center py-8 md:py-12">
        <h1 class="text-4xl md:text-6xl font-black uppercase tracking-wider text-white">
            The <span class="text-cyan-400">Million Dollar</span> Billboard
        </h1>
        <p class="mt-4 text-lg md:text-xl text-gray-400 max-w-3xl mx-auto px-4">
            Own a piece of digital real estate. Drag on the billboard to select your space.
        </p>
    </header>

    <main class="container mx-auto px-4">
        <div class="mb-8">
            <div class="billboard-frame max-w-[1040px] mx-auto">
                <div class="billboard-spotlight"></div>
                <div class="relative w-full aspect-square bg-gray-800 canvas-container">
                    <canvas id="pixel-grid" width="1000" height="1000"></canvas>
                    <canvas id="selection-canvas" width="1000" height="1000" class="pointer-events-none"></canvas>
                    <!-- Loading Overlay -->
                    <div id="loading-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-80 flex items-center justify-center z-10">
                        <p class="text-white text-xl animate-pulse">Loading Billboard...</p>
                    </div>
                </div>
            </div>
            <div class="billboard-stand"></div>
        </div>

        <div class="flex flex-col md:flex-row justify-around items-center bg-gray-900 bg-opacity-70 rounded-xl p-6 mb-8 border border-gray-700 max-w-4xl mx-auto">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <p class="text-sm text-gray-400 uppercase tracking-widest">Pricing</p>
                <p class="text-3xl font-bold text-white">$100 <span class="text-lg font-normal text-gray-300">/ 10x10 block</span></p>
            </div>
            <div class="text-center mb-4 md:mb-0">
                <p class="text-sm text-gray-400 uppercase tracking-widest">Pixels Sold</p>
                <p id="pixels-sold" class="text-3xl font-bold text-cyan-400">0</p>
            </div>
            <div class="text-center mb-4 md:mb-0">
                <p class="text-sm text-gray-400 uppercase tracking-widest">Remaining</p>
                <p id="pixels-remaining" class="text-3xl font-bold text-white">1,000,000</p>
            </div>
        </div>
    </main>

    <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-gray-900 rounded-2xl border border-gray-700 p-8 w-full max-w-md m-4 transform transition-transform duration-300 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Purchase Your Pixels</h2>
                <button id="close-modal" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg mb-4 text-center">
                <p class="text-gray-400">You have selected a <span id="selection-size" class="font-bold text-white">0x0</span> pixel block.</p>
                <p class="text-2xl font-bold text-cyan-400 mt-1">Total: $<span id="total-price-usd">0.00</span></p>
                <p class="text-sm text-gray-500 mt-1">You will be charged approx. <span id="total-price-gbp" class="font-bold">£0.00</span></p>
            </div>
            <div id="purchase-details">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Upload Your Image</label>
                    <div class="flex items-center space-x-4">
                        <img id="image-preview" src="https://placehold.co/80x80/1F2937/4B5563?text=Preview" class="w-20 h-20 rounded-md object-cover border-2 border-gray-600">
                        <label for="image-upload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Choose File
                        </label>
                        <input type="file" id="image-upload" class="hidden" accept="image/png, image/jpeg, image/gif">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="link-url" class="block text-sm font-medium text-gray-300 mb-1">Link URL</label>
                    <input type="url" id="link-url" name="link-url" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" required placeholder="https://yourwebsite.com">
                </div>
                <div class="mb-6">
                    <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Title / Alt Text</label>
                    <input type="text" id="title" name="title" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white" required placeholder="Your company name or message">
                </div>
            </div>
            <div id="paypal-button-container" class="mt-4"></div>
        </div>
    </div>
    
    <div id="message-container" class="fixed bottom-5 right-5 z-50 flex flex-col items-end space-y-2"></div>

    <footer class="text-center py-6 mt-8 border-t border-gray-800">
        <p class="text-gray-500">&copy; 2025 The Million Dollar Billboard. All rights reserved.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- IMPORTANT: Set to 'false' before going live! ---
        const TEST_MODE = true;

        const firebaseConfig = {
            apiKey: "AIzaSyDWvf2nGpOPTLGQJ_q7qY4lCmYxw9n3JWg",
            authDomain: "themilliondollarbillboar-d003e.firebaseapp.com",
            projectId: "themilliondollarbillboar-d003e",
            storageBucket: "themilliondollarbillboar-d003e.firebasestorage.app",
            messagingSenderId: "980560213272",
            appId: "1:980560213272:web:016fab11a5a467af9d5a6d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const pixelGridCanvas = document.getElementById('pixel-grid');
        const gridCtx = pixelGridCanvas.getContext('2d');
        const selectionCanvas = document.getElementById('selection-canvas');
        const selectionCtx = selectionCanvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const GRID_SIZE = 1000;
        const PIXEL_BLOCK_SIZE = 10;
        const PRICE_PER_BLOCK_USD = 100.00; 
        
        let usdToGbpRate = 0.80;
        let totalPriceGbp = 0;
        let isDataLoaded = false;

        const pixelDataCache = new Map();
        let isDragging = false;
        let selectionRect = { x: 0, y: 0, w: 0, h: 0 };
        let startCoords = { x: 0, y: 0 };
        let selectedFile = null;

        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.GBP) {
                    usdToGbpRate = data.rates.GBP;
                }
            } catch (error) {
                console.error("Could not fetch exchange rate, using fallback rate.", error);
            }
        }

        function drawGridLines() {
            gridCtx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            gridCtx.lineWidth = 1;
            for (let i = 0; i <= GRID_SIZE; i += PIXEL_BLOCK_SIZE) {
                gridCtx.beginPath(); gridCtx.moveTo(i, 0); gridCtx.lineTo(i, GRID_SIZE); gridCtx.stroke();
                gridCtx.beginPath(); gridCtx.moveTo(0, i); gridCtx.lineTo(GRID_SIZE, i); gridCtx.stroke();
            }
        }
        
        function updateStats() {
            const soldCount = pixelDataCache.size;
            const totalPixels = GRID_SIZE * GRID_SIZE;
            document.getElementById('pixels-sold').textContent = soldCount.toLocaleString();
            document.getElementById('pixels-remaining').textContent = (totalPixels - soldCount).toLocaleString();
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            const iconClass = type === 'success' ? 'gg-check' : 'gg-info';
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            messageDiv.className = `flex items-center ${bgColor} text-white py-3 px-5 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0`;
            messageDiv.innerHTML = `<i class="${iconClass} mr-3"></i> <p>${text}</p>`;
            container.appendChild(messageDiv);
            setTimeout(() => messageDiv.classList.remove('translate-x-full', 'opacity-0'), 10);
            setTimeout(() => {
                messageDiv.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => messageDiv.remove(), 300);
            }, 4000);
        }

        const pixelsCollection = collection(db, "pixels");
        const unsubscribe = onSnapshot(pixelsCollection, (snapshot) => {
            const initialDocs = snapshot.docChanges().filter(change => change.type === "added");
            let loadedImageCount = 0;

            if (snapshot.empty && !isDataLoaded) {
                isDataLoaded = true;
                loadingOverlay.style.display = 'none';
                selectionCanvas.classList.remove('pointer-events-none');
                return;
            }

            snapshot.docChanges().forEach((change) => {
                const pixel = change.doc.data();
                if (change.type === "added" || change.type === "modified") {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = pixel.img;
                    img.onload = () => {
                        gridCtx.drawImage(img, pixel.x, pixel.y, pixel.w, pixel.h);
                        for (let i = pixel.x; i < pixel.x + pixel.w; i++) {
                            for (let j = pixel.y; j < pixel.y + pixel.h; j++) {
                                pixelDataCache.set(`${i},${j}`, pixel);
                            }
                        }
                        updateStats();

                        if (!isDataLoaded && change.type === "added") {
                            loadedImageCount++;
                            if (loadedImageCount === initialDocs.length) {
                                isDataLoaded = true;
                                loadingOverlay.style.display = 'none';
                                selectionCanvas.classList.remove('pointer-events-none');
                            }
                        }
                    };
                }
            });
        });

        function getEventPos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = evt.type.startsWith('touch') ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.type.startsWith('touch') ? evt.touches[0].clientY : evt.clientY;
            return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
        }

        function handleDragStart(e) {
            isDragging = true;
            const pos = getEventPos(selectionCanvas, e);
            startCoords.x = Math.floor(pos.x / PIXEL_BLOCK_SIZE) * PIXEL_BLOCK_SIZE;
            startCoords.y = Math.floor(pos.y / PIXEL_BLOCK_SIZE) * PIXEL_BLOCK_SIZE;
            selectionRect = { x: startCoords.x, y: startCoords.y, w: 0, h: 0 };
        }

        function handleDragMove(e) {
            if (isDragging && e.type.startsWith('touch')) e.preventDefault();
            if (!isDragging) return;
            const pos = getEventPos(selectionCanvas, e);
            const clampedX = Math.max(0, Math.min(pos.x, GRID_SIZE - 1));
            const clampedY = Math.max(0, Math.min(pos.y, GRID_SIZE - 1));
            const currentX = Math.floor(clampedX / PIXEL_BLOCK_SIZE) * PIXEL_BLOCK_SIZE;
            const currentY = Math.floor(clampedY / PIXEL_BLOCK_SIZE) * PIXEL_BLOCK_SIZE;
            selectionRect.x = Math.min(startCoords.x, currentX);
            selectionRect.y = Math.min(startCoords.y, currentY);
            selectionRect.w = Math.abs(startCoords.x - currentX) + PIXEL_BLOCK_SIZE;
            selectionRect.h = Math.abs(startCoords.y - currentY) + PIXEL_BLOCK_SIZE;
            selectionCtx.clearRect(0, 0, GRID_SIZE, GRID_SIZE);
            selectionCtx.fillStyle = 'rgba(0, 255, 255, 0.3)';
            selectionCtx.fillRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
            selectionCtx.strokeStyle = 'rgba(0, 255, 255, 0.8)';
            selectionCtx.lineWidth = 2;
            selectionCtx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
        }

        function handleDragEnd() {
            if (!isDragging) return;
            isDragging = false;
            if (selectionRect.w < PIXEL_BLOCK_SIZE || selectionRect.h < PIXEL_BLOCK_SIZE) {
                selectionCtx.clearRect(0, 0, GRID_SIZE, GRID_SIZE);
                return;
            }
            const numBlocks = (selectionRect.w / PIXEL_BLOCK_SIZE) * (selectionRect.h / PIXEL_BLOCK_SIZE);
            const totalPriceUsd = numBlocks * PRICE_PER_BLOCK_USD;
            totalPriceGbp = totalPriceUsd * usdToGbpRate;

            document.getElementById('selection-size').textContent = `${selectionRect.w}x${selectionRect.h}`;
            document.getElementById('total-price-usd').textContent = totalPriceUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('total-price-gbp').textContent = `£${totalPriceGbp.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            const paypalContainer = document.getElementById('paypal-button-container');
            paypalContainer.innerHTML = '';
            renderPayPalButtons();

            const modal = document.getElementById('purchase-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('div').classList.remove('scale-95'), 10);
        }

        document.getElementById('image-upload').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('image-preview').src = event.target.result;
                }
                reader.readAsDataURL(selectedFile);
            }
        });

        selectionCanvas.addEventListener('mousedown', handleDragStart);
        selectionCanvas.addEventListener('mousemove', handleDragMove);
        selectionCanvas.addEventListener('mouseup', handleDragEnd);
        selectionCanvas.addEventListener('mouseleave', () => { if (isDragging) handleDragEnd(); });
        selectionCanvas.addEventListener('touchstart', handleDragStart, { passive: false });
        selectionCanvas.addEventListener('touchmove', handleDragMove, { passive: false });
        selectionCanvas.addEventListener('touchend', handleDragEnd);
        
        document.getElementById('close-modal').addEventListener('click', () => {
            const modal = document.getElementById('purchase-modal');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                selectionCtx.clearRect(0, 0, GRID_SIZE, GRID_SIZE);
            }, 300);
        });

        function processImageForUpload(file, targetWidth, targetHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = targetWidth;
                        tempCanvas.height = targetHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        const sourceRatio = img.width / img.height;
                        const targetRatio = targetWidth / targetHeight;
                        let drawX = 0, drawY = 0, drawWidth = targetWidth, drawHeight = targetHeight;
                        if (sourceRatio > targetRatio) {
                            drawHeight = targetWidth / sourceRatio;
                            drawY = (targetHeight - drawHeight) / 2;
                        } else {
                            drawWidth = targetHeight * sourceRatio;
                            drawX = (targetWidth - drawWidth) / 2;
                        }
                        tempCtx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                        tempCanvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error('Canvas to Blob conversion failed'));
                        }, 'image/png');
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function handlePurchase(ownerName = 'Test User') {
            showMessage('Processing image...', 'info');
            try {
                const processedImageBlob = await processImageForUpload(selectedFile, selectionRect.w, selectionRect.h);
                const fileName = `pixels/${Date.now()}-${selectedFile.name.split('.')[0]}.png`;
                const storageRef = ref(storage, fileName);
                const snapshot = await uploadBytes(storageRef, processedImageBlob);
                const downloadURL = await getDownloadURL(snapshot.ref);
                const newPixelData = {
                    ...selectionRect,
                    title: document.getElementById('title').value,
                    owner: ownerName,
                    link: document.getElementById('link-url').value,
                    img: downloadURL,
                    purchaseDate: new Date().toISOString()
                };
                const docId = `${newPixelData.x}-${newPixelData.y}-${newPixelData.w}-${newPixelData.h}`;
                await setDoc(doc(db, "pixels", docId), newPixelData);
                showMessage('Upload complete! Your pixels are live.', 'success');
                document.getElementById('close-modal').click();
                document.getElementById('image-upload').value = '';
                document.getElementById('image-preview').src = 'https://placehold.co/80x80/1F2937/4B5563?text=Preview';
                ['link-url', 'title'].forEach(id => document.getElementById(id).value = '');
                selectedFile = null;
            } catch (error) {
                console.error("Error during upload or save: ", error);
                showMessage('Image processing failed.', 'error');
            }
        }

        function renderPayPalButtons() {
            try {
                paypal.Buttons({
                    onClick: (data, actions) => {
                        if (!selectedFile || !document.getElementById('link-url').value || !document.getElementById('title').value) {
                            showMessage('Please fill out all fields and upload an image.', 'error');
                            return actions.reject();
                        }
                        for (let i = selectionRect.x; i < selectionRect.x + selectionRect.w; i++) {
                            for (let j = selectionRect.y; j < selectionRect.y + selectionRect.h; j++) {
                                if (pixelDataCache.has(`${i},${j}`)) {
                                    showMessage('Your selection overlaps with purchased pixels.', 'error');
                                    return actions.reject();
                                }
                            }
                        }
                        return actions.resolve();
                    },
                    createOrder: (data, actions) => {
                        return actions.order.create({
                            purchase_units: [{
                                description: `${selectionRect.w}x${selectionRect.h} Pixels on The Million Dollar Billboard`,
                                amount: { value: totalPriceGbp.toFixed(2) }
                            }]
                        });
                    },
                    onApprove: (data, actions) => actions.order.capture().then((details) => {
                        handlePurchase(details.payer.name.given_name);
                    }),
                    onCancel: (data) => {
                        showMessage('Payment was cancelled.', 'info');
                    },
                    onError: (err) => showMessage('An error occurred with the payment.', 'error')
                }).render('#paypal-button-container');
            } catch (error) {
                console.error("Failed to render PayPal buttons", error);
            }
        }

        if (TEST_MODE) {
            const testButton = document.createElement('button');
            testButton.textContent = 'Test Upload (No Payment)';
            testButton.className = 'w-full mt-2 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition-colors';
            testButton.onclick = () => {
                if (!selectedFile || !document.getElementById('link-url').value || !document.getElementById('title').value) {
                    showMessage('Please fill out all fields and upload an image.', 'error');
                    return;
                }
                handlePurchase();
            };
            document.getElementById('paypal-button-container').after(testButton);
        }

        fetchExchangeRate();
        drawGridLines();
    </script>
</body>
</html>
